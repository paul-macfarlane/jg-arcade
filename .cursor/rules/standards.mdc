---
alwaysApply: true
description: Codebase Wide Standards
---
# Overview

This rule is a catch-all for codebase wide standards.

## File Structure

- All Next.js pages should be in the `src/app` directory.
- Componets that are re-used across multiple pages should be in the `src/components` directory.
- Components that are only used in a single page should be colocated with the page in the `src/app` directory.
- Database operations should be in the `src/db` directory.
- Business logic functions should be in the `src/services` directory.
- Server Actions should be colocated with the page in the `src/app` directory, unless the action is used in multiple pages, in which case it should be in the `src/actions` directory.

## General Standards

- Keep code DRY (Don't Repeat Yourself), do not repeat business logic in multiple places. Do not repeat UI fragments in multiple places.
- Maintain type safety by defining input and output types for functions and components (one exception is components do not need output types).

## Authentication Standards

We use Better Auth for authentication. Consult the [Better Auth Documentation](https://better-auth.com/docs) for how to use the library.

In this codebase in particular:

- When working with auth on the server, use src/lib/auth.ts to authenticate requests.
- When working with auth on the client, use src/lib/auth-client.ts to authenticate requests.

## Database Standards

We use Drizzle ORM for database operations and integration with Turso. Consult the [Drizzle Documentation](https://orm.drizzle.team/docs/tutorials/drizzle-with-turso) for how to use the library.

- All schema changes should have a migration file generated by running `pnpm run db:generate` and can then be applied by running `pnpm run db:migrate`.
- Database operations should be done in the `src/db` directory, in a file named based on the business domain for the database operations. For example, if the database operations are related to users, the file should be named `users.ts`.
- Database functions should support being run on their own AND within a transaction.
- Database functions should be named in a format of <action><subject><queryType>. For example, `createUser`, `getUserById`, `updateUserEmail`.
- Database query functions should generally be limited to a single query unless the query is complex or requires multiple steps.
- Database functions should be very limited in business logic
- Database functions should only be called by service functions, and never directly by other functions or components.
- Database Types can be made by using DrizzleORM's `inferSelect` and `inferInsert` functions, and should be used. These can be defined in the `src/db/schema.ts` file.

## Next.js Standards

- All Next.js pages should be server components.
- All Next.js components should be server components unless client reactivity is needed.
- Server components when fetching data should not make direct database calls, but should call a business logic function that will handle the database call.
- Server components that fetch data should be async functions and utilize [Streaming](https://nextjs.org/docs/app/getting-started/fetching-data#streaming) to fetch data from the server. A `loading.ts` file can be used for route segements (layouts and pages), but if the loading is more granular, Suspense can be used to handle the loading state.
- In general, we should use Server Components where possible. Anytime client reactivity is needed, we should use Client Components, but instead of making a large component a client component, we should split it into smaller components that are client components where the interactivity is needed, but still maintain a server component that uses the client components to render the page.
- All Next.js API routes should be in the `src/app/api` directory. API routes are only need if an external app needs to integrate with the app. Internally, we should use server actions.
- Server Actions should always take in an "unknown" type for the input and then pass it to a service function to handle the business logic.
- Server Actions should be thin, and should only focus on takin input from the client calling a service functions, and then returning the result to the client in the format that is needed.

## Service Standards

Business logic functions should be in the `src/services` directory.

- Services should call database functions, but nothing else should call them 
- Services should have unit tests, mocking external dependencies and only testing input and output. No need to test "was this function called with the correct input".
- Services may take in an "unknown" type for the input and then use zod to validate the input.
- The idea behind this is to put as much business logic in the service layer, so that if we ever want to change to a separate API layer, we can do so with minimal changes to the business logic.

## Styling Standards

We use ShadCN's Component Library for styling. 

- We should be use components from the library where possible, and avoid creating custom components unless absolutely necessary.
- consult the [ShadCN Component Library](https://ui.shadcn.com/docs/components) for the available components.
- Arbitrary colors should not be used. Instead, use the theme colors defined in the `globals.css` file. If a new color is needed, add it to the `globals.css` file.
